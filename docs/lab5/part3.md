#  实验步骤

##  1. 任务一： 简单的文件系统demo

为了便于同学们过渡到任务二，我们在任务一要求同学们实现一个简单的文件系统小demo。通过这个简单的小demo，帮助大家理解和熟悉：

- 简单的磁盘布局。磁盘逻辑块划分的概念以及本次实验逻辑块大小。

- 简单的磁盘交互。利用本次实验提供的磁盘操作（驱动）接口。
- 简单的文件系统接口实现。什么是文件系统接口等。

这个文件系统小demo的实现要求如下：

- 只需要实现`ls`命令，并且`ls`只需要在根目录显示某个的固定的普通文件名`<filename>`即可。
- 通过磁盘驱动接口`ddriver_ioctl`获取磁盘相关信息：磁盘容量，IO块大小
- 文件系统demo的一个逻辑块是两个IO块大小，假设第500个逻辑块为根目录的数据块，这个数据块只有一个dentry，也就是名为`<filename>`的dentry。
- 出于简单示例，除了上述的块，磁盘其他块都是空的，无需做其他复杂考虑，同学只需要根据demo的`/ * TODO */` 指引完成demo即可。

假设`<filename>`为`file.txt`（实际可能不是`file.txt`），文件系统的demo效果将会如下：

![](./part3.assets/task1效果.png)

TODO：测试

##  2. 任务二：基于FUSE实现青春版EXT2文件系统

熟悉了驱动后，我们也就基本掌握了访问 **DDRIVER** 设备的方法。接下来我们就可以基于FUSE来正式编写 **青春版EXT2文件系统** 了。我们已经在 **环境配置** 阶段就为大家搭建好了FUSE文件系统项目框架。

本次实验可以参考两个完全搭建好的FUSE文件系统：`simplefs`（`fs/simplefs`文件夹下）和`myfs`（`fs/samples`文件夹下），其中`simplefs`是一个类EXT2的文件系统，但 **没有给予数据位图** 的实现；`myfs`是`github`上的一个开源项目，也是一个FUSE文件系统实例。

注意，在本实验中，simplefs和sfs都代表Simple File System。

### 2.1 实现内容

- 文件系统的逻辑块应该为1024B，两个IO大小（512B）单位。注意，simplefs中的逻辑块是512B。
- 布局中需要引入数据位图。注意，simplefs中不存在数据位图。
- 无需实现软链接和硬链接，一个inode只对应到一个文件。作为选做。
- 只用实现直接索引即可，间接索引作为选做。
- 统一都不实现"."和".."两个特殊目录。实现可能会评测脚本无法通过。

### 2.2 实现步骤建议

-   封装对 **ddriver** 的访问代码，方便设备读写。注意驱动读写IO为512B，但是EXT2文件系统一个块大小为1024B，也就是两个IO单位。在simplefs文件系统中也封装了 **ddriver** 的访问代码，然而simplefs是按一个块大小为512B来封装的（详见sfs_utils.c的sfs_driver_read函数）。

-   设计介质数据结构（位于`types.h`）；

-   设计内存数据结构（可设计、可不设计）；

-   仔细阅读`include/fs.layout`文件，并按要求设计填写自己的文件系统布局，在测试umount时会对文件系统布局进行检测；

-   完成`.init`钩子：读 **超级块** 、初始化文件系统；

-   完成`.destroy`钩子： **回写必要结构** ，保证下一次挂载正常；

-   验证挂载卸载流程的正确性（ **主要看读写是否正确** ）；

-   完成工具函数（可自行设计）：

    -   完成 **分配inode** 函数：创建一个Inode、初始化其上的字段、修改位图结构，可能还需要修改超级块；

    -   完成 **分配dentry** 函数：创建一个dentry、初始化其上的字段；

    -   完成将 **dentry加入到inode** 中的函数：将生成的dentry写入到inode中；

    -   完成 **路径解析函数** ，要么返回dentry，要么返回inode，可自行设计；

-   根据工具函数，完成`.get_attr`钩子；

-   根据工具函数，完成`.mknod`钩子；

-   根据工具函数，完成`.mkdir`钩子；

-   根据工具函数，完成`.readdir`钩子；

-   手工测试`touch`、`ls`、 `mkdir`、`fusermount -u`等命令的正确性；

-   通过`./tests/test.sh`脚本的基本功能测试。

